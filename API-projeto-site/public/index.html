<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site pessoal</title>
    <link rel="stylesheet" href="./css/style.css">
    <link rel="stylesheet" href="./css/loading.css">

</head>

<body class="toLoad">
    <section id="loadScreen">
        <%- include('load.html'); %>
    </section>


    <div class="content-holder">

        <div class="side-menu">
            <div class="profileIcon">
                <div class="icon">
                    <img id="summonerIcon" src="" alt="">
                    <div id="level" class="level"></div>
                </div>
                <div id="username">
                </div>
            </div>
        </div>

        <div class="content">
            <div class="profile-home">
                <div class="history-container">
                    <!-- <div class="match">
                        <div class="general-stats">
                            <div class="champ-icon">
                                <img src="http://ddragon.leagueoflegends.com/cdn/11.10.1/img/champion/Aatrox.png" alt=""
                                    srcset="">
                            </div>
                            <div class="status-kda">
                                <div class="status defeat">Derrota</div>
                                <div class="kda-holder">
                                    <div class="kda">1/0/10</div>
                                    <div class="ama">KDA: 3,2</div>
                                </div>
                            </div>
                        </div>
                        <div class="cs">
                            <div class="icon">
                                <img src="https://streamie.com.br/wp-content/uploads/2017/08/img-icone-6.png" alt=""
                                    class="src">
                            </div>
                            <p>140</p>
                        </div>
                    </div> -->
                </div>
            </div>

        </div>

    </div>


    <!-- 
    <section class="mainContent">
        <div class="principal-bg">

            <div class="slogan">
                <h1 class="title red">Summoner's Guide</h1>

            </div>
        </div>
    </section> -->
    <!-- <section class="loreSection">
        <h1 class="title">O que é League of Legends?</h1>
        <p class="loreDesc">League of Legends é um jogo de estratégia em que duas equipes de cinco poderosos Campeões se
            enfrentam para destruir a
            base uma da outra. Escolha entre mais de 140 Campeões para realizar jogadas épicas, assegurar abates e
            destruir torres
            conforme você luta até a vitória.
        </p>
    </section> -->

    <script src="./js/main.js"></script>
    <script>

        let pageContent = document.querySelector('.page-content')
        let user = sessionStorage.getItem('user');
        user = JSON.parse(user);

        username.innerHTML = user.name;
        level.innerHTML = user.summonerLevel;





        let icon = document.querySelector('#summonerIcon');
        icon.src = `http://ddragon.leagueoflegends.com/cdn/11.10.1/img/profileicon/${user.profileIconId}.png`;



        let accId = user.accountId;
        let matchList = {}
        let history = []
        let championData = {};

        let insertMatch = async () => {

            fetch(`summoner/getChampion/${history[history.length - 1].championId}`, {
                method: 'GET'
            }).then((response) => {
                if (response.ok) {
                    response.json().then(async (data) => {

                        document.querySelector('.history-container').innerHTML += `
                        <div class="match">
                        <div class="general-stats">
                            <div class="champ-icon">
                                <img src="http://ddragon.leagueoflegends.com/cdn/11.10.1/img/champion/${data.name}.png" alt=""
                                    srcset="">
                            </div>
                            <div class="status-kda">
                                <div class="status ${history[history.length - 1].data.stats.win ? 'win' : 'defeat'}">
                                ${history[history.length - 1].data.stats.win ? 'Vitória' : 'Derrota'}    
                                </div>
                                <div class="kda-holder">
                                    <div class="kda">1/0/10</div>
                                    <div class="ama">KDA: 3,2</div>
                                </div>
                            </div>
                        </div>
                        <div class="cs">
                            <div class="icon">
                                <img src="https://streamie.com.br/wp-content/uploads/2017/08/img-icone-6.png" alt=""
                                    class="src">
                            </div>
                            <p>140</p>
                        </div>
                    </div>`;
                    })
                }
            });


        }



        getMatchList = async () => {
            fetch(`summoner/getMatchList/${accId}`, {
                method: 'GET',
            }).then((response) => {
                if (response.ok) {
                    response.json().then(async (data) => {
                        matchList = data;
                        await matchList.matches.splice(10, (matchList.matches.length - 1));

                        matchList.matches.forEach(match => {
                            let newJson = {
                                championId: match.champion,
                                gameId: match.gameId,
                                lane: match.lane,
                                role: match.role,
                                timestamp: match.timestamp,
                                gameDuration: '',
                                queueId: '',
                                gameMode: '',
                                gameType: '',
                                teams: [],
                                participants: [],
                                participantIdentities: [],
                                data: [],
                            }

                            fetch(`summoner/getMatch/${match.gameId}`, {
                                method: 'GET'
                            }).then((response) => {
                                if (response.ok) {
                                    response.json().then(async (data) => {
                                        let inMatchId;
                                        newJson.gameDuration = data.gameDuration;
                                        newJson.queueId = data.queueId;
                                        newJson.gameMode = data.gameMode;
                                        newJson.gameType = data.gameType;
                                        newJson.teams = data.teams;
                                        newJson.participants = data.participants;
                                        newJson.participantIdentities = data.participantIdentities;

                                        newJson.participantIdentities.forEach((participant) => {
                                            if (user.accountId == participant.player.accountId) {
                                                inMatchId = participant.participantId;
                                            }
                                        })

                                        newJson.participants.forEach(player => {
                                            if (player.participantId == inMatchId) {
                                                newJson.data = player;
                                            }
                                        })


                                        history.push(newJson);
                                        await insertMatch();

                                    })
                                } else {
                                    console.log(response.statusText);
                                }
                            }).catch((error) => {
                                console.log(error);
                            })

                        })
                    });

                } else {
                    console.log(response.statusText)
                }
            }).catch((error) => {
                console.log(error);
            });
        }


        getMatchList();










    </script>
</body>

</html>